pipeline {
    agent {
        docker {
            image 'samyogg/java-cicd-pipeline:v1'
            args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }

    stages {

        stage('Build and Test') {
            steps {
                dir('spring-boot-app') {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Build Docker Image') {
            environment {
                IMAGE_NAME = 'samyogg/java-cicd-pipeline:v1'
                REGISTRY_CREDENTIALS = 'dockerhub-samyogg'
            }
            steps {
                script {
                    sh "docker build -t ${IMAGE_NAME} ."

                    def dockerImage = docker.image(IMAGE_NAME)
                    docker.withRegistry('', REGISTRY_CREDENTIALS) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage('Update Deployment File') {
            environment {
                GIT_REPO_NAME = 'CICD-Pipeline'
                GIT_USER_NAME = 'SamyogGhimire'
            }
            steps {
                script {
                    sh """
                        git config user.email "samyog.ghimire25@gmail.com"
                        git config user.name "${GIT_USER_NAME}"

                        sed -i 's|image: .*|image: samyogg/java-cicd-pipeline:v1|g' k8s-app-manifests/deployment.yaml

                        git add k8s-app-manifests/deployment.yaml
                        git commit -m "Updated deployment image to samyogg/java-cicd-pipeline:v1 for build number ${BUILD_NUMBER}"
                        git push https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git
                    """
                }
            }
        }
    }
}
